{% extends "base.html" %}

{% block title %}Home - Cruzy Coffee Co.{% endblock %}

{% block content %}
<!-- Multi-Slide Hero Carousel -->
<section class="hero-carousel">
    <div class="hero-slides">
        <!-- Slide 1 - BLACK FRIDAY PROMO -->
        <div class="hero-slide hero-slide-split">
            <div class="hero-split-container">
                <!-- Left: Image -->
                <div class="hero-split-right" style="background-image: url('{{ url_for('static', filename='img/black_friday.webp') }}');"></div>
                <!-- Right: Black section with text and animations -->
                <div class="hero-split-left" style="background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);">
                    <div class="hero-split-content">
                        <!-- Animated "LIMITED TIME" badge with yellow background -->
                        <span class="badge bg-warning text-dark mb-3 fs-6 limited-time-badge">
                            ⏰ LIMITED TIME ONLY
                        </span>
                        
                        <!-- Black Friday Title with glitch effect -->
                        <h1 class="display-3 fw-bold mb-3 black-friday-title">
                            BLACK FRIDAY
                        </h1>
                        
                        <!-- Discount banner -->
                        <div class="discount-banner mb-4">
                            <span class="discount-text">10% OFF</span>
                            <span class="discount-subtext">ALL ACCESSORIES</span>
                        </div>
                        
                        <p class="lead mb-4 text-white-50">
                            Upgrade your coffee setup with premium grinders, tampers, and brewing tools. 
                            <strong class="text-warning">This week only!</strong>
                        </p>
                        
                        <!-- Countdown timer effect (static for now) -->
                        <div class="countdown-container mb-4">
                            <div class="countdown-item">
                                <span class="countdown-number">03</span>
                                <span class="countdown-label">DAYS</span>
                            </div>
                            <div class="countdown-separator">:</div>
                            <div class="countdown-item">
                                <span class="countdown-number">12</span>
                                <span class="countdown-label">HOURS</span>
                            </div>
                            <div class="countdown-separator">:</div>
                            <div class="countdown-item">
                                <span class="countdown-number">45</span>
                                <span class="countdown-label">MINS</span>
                            </div>
                        </div>
                        
                        <a href="{{ url_for('accessories') }}" class="btn btn-warning btn-lg btn-black-friday">
                            Shop Accessories <i class="bi bi-arrow-right ms-2"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 2 - Keep original full-screen style -->
        <div class="hero-slide" style="background-image: url('{{ url_for('static', filename='img/Homepage_cof.webp') }}');">
            <div class="hero-overlay"></div>
            <div class="hero-content">
                <div class="container text-center text-white">
                    <h1 class="display-3 fw-bold mb-3 hero-title">Discover exceptional coffee</h1>
                    <p class="lead mb-4 hero-subtitle">Specialty beans, premium machines and crafted accessories.</p>
                    <a href="#product-categories" class="btn btn-outline-light btn-lg scroll-to-categories">Shop Coffee</a>
                </div>
            </div>
        </div>

        <!-- Slide 3 - Split layout (Text LEFT, Image RIGHT) - SUMMER BLEND PROMO -->
        <div class="hero-slide hero-slide-split">
            <div class="hero-split-container">
                <!-- Left: Black section with text -->
                <div class="hero-split-left">
                    <div class="hero-split-content">
                        <span class="badge bg-warning text-dark mb-3 fs-6">New Arrival</span>
                        <h1 class="display-4 fw-bold mb-4">Limited Seasonal Roast</h1>
                        <h2 class="h3 mb-4 text-white-50">Summer Blend — First Batch</h2>
                        <p class="lead mb-4">Small batch. Limited time. Experience our exclusive seasonal flavour.</p>
                        <a href="{{ url_for('product_detail', product_id=get_summer_blend_id()) }}" class="btn btn-light btn-lg">
                            Discover More <i class="bi bi-arrow-right ms-2"></i>
                        </a>
                    </div>
                </div>
                <!-- Right: Image -->
                <div class="hero-split-right" style="background-image: url('{{ url_for('static', filename='img/summer-blend-promo.webp') }}');"></div>
            </div>
        </div>
    </div>

    <!-- Navigation Dots -->
    <div class="hero-dots">
        <span class="hero-dot active" data-slide="0"></span>
        <span class="hero-dot" data-slide="1"></span>
        <span class="hero-dot" data-slide="2"></span>
    </div>

    <!-- Navigation Arrows -->
    <button class="hero-arrow hero-arrow-prev" aria-label="Previous slide">
        <i class="bi bi-chevron-left"></i>
    </button>
    <button class="hero-arrow hero-arrow-next" aria-label="Next slide">
        <i class="bi bi-chevron-right"></i>
    </button>
</section>

<!-- Promotional cards with AOS animations -->
<section class="container py-5">
    <div class="row g-4 align-items-stretch">
        <!-- Left: On Sale machine -->
        <div class="col-12 col-lg-6" 
             data-aos="fade-up" 
             data-aos-duration="800" 
             data-aos-delay="100">
            {% set breville_id = get_breville_id() %}
            <a href="{{ url_for('product_detail', product_id=breville_id) }}" class="text-decoration-none">
                <div class="position-relative rounded overflow-hidden hero-promo promo-card-hover" 
                     style="min-height:54vh; background-image: url('{{ url_for('static', filename='img/breville_express_promo.jpg') }}'); background-size:cover; background-position:center;">
                    <div class="hero-overlay"></div>
                    <div class="hero-content p-5">
                        <span class="badge bg-warning text-dark mb-3 badge-pulse">
                            <i class="bi bi-tag-fill me-1"></i>On Sale
                        </span>
                        <h2 class="display-5 fw-bold text-white">Barista Express — 10% Off</h2>
                        <p class="lead text-white">Limited time — our most-loved semi-automatic machine. Free shipping this week.</p>
                        <button class="btn btn-light btn-lg btn-hover-slide">
                            Learn More <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </a>
        </div>

        <!-- Right: Membership option -->
        <div class="col-12 col-lg-6" 
             data-aos="fade-up" 
             data-aos-duration="800" 
             data-aos-delay="300">
            <a href="{{ url_for('membership') }}" class="text-decoration-none">
                <div class="position-relative rounded overflow-hidden promo-card-hover" 
                     style="min-height:54vh; background-image: url('{{ url_for('static', filename='img/membership.jpg') }}'); background-size:cover; background-position:center;">
                    <div style="position:absolute; inset:0; background: linear-gradient(180deg, rgba(245,240,230,0.18), rgba(245,240,230,0.45));"></div>
                    <div style="position:relative; z-index:2; padding:3.5rem;">
                        <span class="badge bg-dark text-white mb-3 badge-pulse">
                            <i class="bi bi-star-fill me-1"></i>Exclusive
                        </span>
                        <h2 class="display-5 fw-bold" style="color:#1A1A1A;">Member Benefits</h2>
                        <p class="lead" style="color:#333333;">Exclusive discounts, early access to limited releases and free shipping for members.</p>
                        <button class="btn btn-dark btn-lg btn-hover-slide">
                            Discover <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </a>
        </div>
    </div>
</section>

<!-- Horizontal Promo Bars (BEFORE Category Cards) -->
<section class="container-fluid py-3 bg-light">
    <div class="container">
        <!-- Bar 1: Slides from LEFT with popup -->
        <div class="promo-bar promo-bar-left mb-4" 
             data-aos="fade-right" 
             data-aos-duration="1000" 
             data-aos-easing="ease-out-cubic"
             data-aos-once="true">
            <div class="promo-bar-content">
                <div class="promo-bar-image">
                    <img src="{{ url_for('static', filename='img/homegrown.webp') }}" alt="Cruzy Homegrown Beans">
                </div>
                <div class="promo-bar-text">
                    <span class="badge bg-danger text-white mb-3">
                        <i class="bi bi-star-fill me-1"></i>Limited Release
                    </span>
                    <h3 class="display-6 fw-bold mb-3">Cruzy Homegrown Beans</h3>
                    <p class="lead text-muted mb-4">
                        Exclusive single-origin beans from our private estate. 
                        Roasted in small batches for the finest flavor profile.
                    </p>
                    <a href="{{ url_for('product_detail', product_id=get_cruzy_beans_id()) }}" class="btn btn-dark btn-lg">
                        Pre-Order Now <i class="bi bi-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Bar 2: Slides from RIGHT with popup -->
        <div class="promo-bar promo-bar-right" 
             data-aos="fade-left" 
             data-aos-duration="1000" 
             data-aos-easing="ease-out-cubic"
             data-aos-once="true"
             data-aos-delay="200">
            <div class="promo-bar-content">
                <div class="promo-bar-text">
                    <span class="badge bg-info text-white mb-3">
                        <i class="bi bi-book me-1"></i>New Guide
                    </span>
                    <h3 class="display-6 fw-bold mb-3">Brewing Guide for Beginners</h3>
                    <p class="lead text-muted mb-4">
                        Learn the fundamentals of coffee brewing. From bean selection 
                        to the perfect extraction — your journey starts here.
                    </p>
                    <a href="{{ url_for('coming_soon') }}" class="btn btn-dark btn-lg">
                        Read Guide <i class="bi bi-arrow-right ms-2"></i>
                    </a>
                </div>
                <div class="promo-bar-image">
                    <img src="{{ url_for('static', filename='img/coffee_tools_home.webp') }}" alt="Brewing Guide">
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Trending Products Section -->
<section class="container py-3">
    <div class="text-center mb-4" 
         data-aos="fade-down" 
         data-aos-duration="600">
        <h2 class="display-5 fw-bold mb-3">Trending Products</h2>
        <p class="lead text-muted">Popular picks from our customers this week</p>
    </div>

    <div class="trending-products-wrapper">
        <!-- Left Scroll Button -->
        <button class="trending-scroll-btn trending-scroll-left" aria-label="Scroll left">
            <i class="bi bi-chevron-left"></i>
        </button>

        <!-- Products Container -->
        <div class="trending-products-container" id="trendingProductsContainer">
            <div class="trending-products-track">
                {% for product in trending_products %}
                <div class="trending-product-card">
                    <a href="{{ url_for('product_detail', product_id=product.id) }}" class="text-decoration-none">
                        <div class="card h-100 product-card">
                            <div class="trending-card-img-wrapper">
                                {% if product.image %}
                                <img src="{{ url_for('static', filename='img/' + product.image) }}" 
                                     class="card-img-top" 
                                     alt="{{ product.name }}">
                                {% else %}
                                <img src="{{ url_for('static', filename='img/placeholder.jpg') }}" 
                                     class="card-img-top" 
                                     alt="{{ product.name }}">
                                {% endif %}
                                
                                {% if product.discount_percentage and product.discount_percentage > 0 %}
                                <span class="badge bg-warning text-dark trending-badge">
                                    <i class="bi bi-tag-fill me-1"></i>{{ product.discount_percentage }}% OFF
                                </span>
                                {% endif %}
                            </div>
                            
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title text-dark mb-2">{{ product.name }}</h6>
                                
                                <div class="mt-auto">
                                    {% if product.discount_percentage and product.discount_percentage > 0 %}
                                    {% set discounted_price = product.price * (1 - product.discount_percentage / 100) %}
                                    <div class="mb-3">
                                        <span class="text-decoration-line-through text-muted small">
                                            ${{ '%.2f'|format(product.price) }}
                                        </span>
                                        <br>
                                        <span class="fw-bold text-success fs-6">
                                            ${{ '%.2f'|format(discounted_price) }}
                                        </span>
                                    </div>
                                    {% else %}
                                    <p class="fw-bold mb-3 fs-6">${{ '%.2f'|format(product.price) }}</p>
                                    {% endif %}
                                    
                                    <a href="{{ url_for('product_detail', product_id=product.id) }}" 
                                       class="btn btn-outline-dark btn-sm w-100 trending-view-btn">
                                        View Product <i class="bi bi-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Right Scroll Button -->
        <button class="trending-scroll-btn trending-scroll-right" aria-label="Scroll right">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>
</section>

<!-- Product Categories with animations -->
<section class="container py-3" id="product-categories">
    <!-- Section Header -->
    <div class="text-center mb-4" 
         data-aos="fade-down" 
         data-aos-duration="600">
        <h2 class="display-5 fw-bold mb-3">Shop by Category</h2>
        <p class="lead text-muted">Explore our curated collection of premium coffee products</p>
    </div>

    <div class="row g-4">
        <!-- Card 1: Machines -->
        <div class="col-md-4" 
             data-aos="zoom-in" 
             data-aos-duration="700" 
             data-aos-delay="100">
            <div class="card product-card category-card h-100">
                <div class="category-card-img-wrapper">
                    <img src="{{ url_for('static', filename='img/coffee_machine_home_pic.webp') }}" 
                         class="card-img-top" 
                         alt="Machines">
                    <div class="category-overlay">
                        <i class="bi bi-cup-hot category-icon"></i>
                    </div>
                </div>
                <div class="card-body">
                    <h5 class="card-title">Coffee Machines</h5>
                    <p class="card-text text-muted">Home and prosumer espresso machines.</p>
                    <a href="{{ url_for('machines', category='semi-auto') }}" class="btn btn-modern btn-hover-slide w-100">
                        View Machines <i class="bi bi-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Card 2: Beans and Capsules (Roastery) -->
        <div class="col-md-4" 
             data-aos="zoom-in" 
             data-aos-duration="700" 
             data-aos-delay="300">
            <div class="card product-card category-card h-100">
                <div class="category-card-img-wrapper">
                    <img src="{{ url_for('static', filename='img/bean_home.jpg') }}" 
                         class="card-img-top" 
                         alt="Beans and Capsules">
                    <div class="category-overlay">
                        <i class="bi bi-bag-fill category-icon"></i>
                    </div>
                </div>
                <div class="card-body">
                    <h5 class="card-title">Beans and Capsules</h5>
                    <p class="card-text text-muted">Roasted beans & capsules.</p>
                    <a href="{{ url_for('beans') }}" class="btn btn-modern btn-hover-slide w-100">
                        Browse Roastery <i class="bi bi-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Card 3: Accessories -->
        <div class="col-md-4" 
             data-aos="zoom-in" 
             data-aos-duration="700" 
             data-aos-delay="500">
            <div class="card product-card category-card h-100">
                <div class="category-card-img-wrapper">
                    <img src="{{ url_for('static', filename='img/coffee_tools_home.webp') }}" 
                         class="card-img-top" 
                         alt="Accessories">
                    <div class="category-overlay">
                        <i class="bi bi-tools category-icon"></i>
                    </div>
                </div>
                <div class="card-body">
                    <h5 class="card-title">Accessories</h5>
                    <p class="card-text text-muted">Grinders, tampers, cups & more.</p>
                    <a href="{{ url_for('accessories') }}" class="btn btn-modern btn-hover-slide w-100">
                        See Accessories <i class="bi bi-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<!-- AOS (Animate On Scroll) Library -->
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<!-- AOS (Animate On Scroll) Library -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<script>
    // Initialize AOS
    AOS.init({
        duration: 1000,
        easing: 'ease-out-cubic',
        once: true,
        offset: 100,
        delay: 0,
    });

    // Hero carousel code with FIXED TIMING
    const slides = document.querySelectorAll('.hero-slide');
    const dots = document.querySelectorAll('.hero-dot');
    const prevBtn = document.querySelector('.hero-arrow-prev');
    const nextBtn = document.querySelector('.hero-arrow-next');
    let currentSlide = 0;  // This starts at index 0 (first slide in DOM)
    const totalSlides = slides.length;
    let autoplayInterval = null;
    let autoplayTimeout = null;
    const SLIDE_DURATION = 7000;
    let slideStartTime = Date.now();

    // INITIALIZE: Show first slide on page load
    showSlide(0);  // ← ADD THIS LINE to explicitly show slide 0

    function showSlide(index) {
        slides.forEach((slide, i) => {
            slide.classList.remove('active');
            dots[i].classList.remove('active');
        });
        
        if (index >= totalSlides) {
            currentSlide = 0;
        } else if (index < 0) {
            currentSlide = totalSlides - 1;
        } else {
            currentSlide = index;
        }
        
        slides[currentSlide].classList.add('active');
        dots[currentSlide].classList.add('active');
        
        // Reset the start time when showing a new slide
        slideStartTime = Date.now();
    }

    function nextSlide() {
        showSlide(currentSlide + 1);
    }

    function prevSlide() {
        showSlide(currentSlide - 1);
    }

    function stopAutoplay() {
        // Clear BOTH interval and timeout
        if (autoplayInterval) {
            clearInterval(autoplayInterval);
            autoplayInterval = null;
        }
        if (autoplayTimeout) {
            clearTimeout(autoplayTimeout);
            autoplayTimeout = null;
        }
    }

    function startAutoplay() {
        // IMPORTANT: Stop everything first
        stopAutoplay();
        
        // Calculate remaining time for current slide
        const elapsedTime = Date.now() - slideStartTime;
        const remainingTime = Math.max(0, SLIDE_DURATION - elapsedTime);
        
        // Wait for remaining time, then start regular interval
        autoplayTimeout = setTimeout(() => {
            nextSlide();
            // Now start the regular interval
            autoplayInterval = setInterval(nextSlide, SLIDE_DURATION);
        }, remainingTime);
    }

    function resetAutoplay() {
        stopAutoplay();
        startAutoplay();
    }

    // Navigation button clicks
    nextBtn.addEventListener('click', () => {
        nextSlide();
        resetAutoplay();
    });

    prevBtn.addEventListener('click', () => {
        prevSlide();
        resetAutoplay();
    });

    // Dot clicks
    dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
            showSlide(index);
            resetAutoplay();
        });
    });

    // Touch support
    let touchStartX = 0;
    let touchEndX = 0;

    document.querySelector('.hero-carousel').addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
    });

    document.querySelector('.hero-carousel').addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });

    function handleSwipe() {
        if (touchEndX < touchStartX - 50) {
            nextSlide();
            resetAutoplay();
        }
        if (touchEndX > touchStartX + 50) {
            prevSlide();
            resetAutoplay();
        }
    }

    // Smooth scroll for "Shop Coffee" button
    document.querySelector('.scroll-to-categories').addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelector('#product-categories').scrollIntoView({ 
            behavior: 'smooth' 
        });
    });

    // Trending Products Horizontal Scroll
    const trendingContainer = document.querySelector('.trending-products-container');
    const trendingTrack = document.querySelector('.trending-products-track');
    const scrollLeftBtn = document.querySelector('.trending-scroll-left');
    const scrollRightBtn = document.querySelector('.trending-scroll-right');

    if (trendingContainer && trendingTrack && scrollLeftBtn && scrollRightBtn) {
        const gap = 24; // 1.5rem = 24px
        const cardWidth = 280; // Width of each card
        const scrollAmount = (cardWidth + gap) * 4; // Scroll 4 cards at a time
        let currentScroll = 0;

        function updateButtons() {
            const maxScroll = trendingTrack.scrollWidth - trendingContainer.clientWidth;
            
            // Hide left button at start
            if (currentScroll <= 0) {
                scrollLeftBtn.classList.add('hidden');
            } else {
                scrollLeftBtn.classList.remove('hidden');
            }
            
            // Hide right button at end
            if (currentScroll >= maxScroll - 10) { // -10 for small tolerance
                scrollRightBtn.classList.add('hidden');
            } else {
                scrollRightBtn.classList.remove('hidden');
            }
        }

        function scrollTo(position) {
            const maxScroll = trendingTrack.scrollWidth - trendingContainer.clientWidth;
            currentScroll = Math.max(0, Math.min(maxScroll, position));
            trendingTrack.style.transform = `translateX(-${currentScroll}px)`;
            updateButtons();
        }

        scrollLeftBtn.addEventListener('click', () => {
            scrollTo(currentScroll - scrollAmount);
        });

        scrollRightBtn.addEventListener('click', () => {
            scrollTo(currentScroll + scrollAmount);
        });

        // Touch/Mouse drag scrolling
        let isDragging = false;
        let startX;
        let scrollLeft;

        trendingContainer.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.pageX - trendingContainer.offsetLeft;
            scrollLeft = currentScroll;
            trendingContainer.style.cursor = 'grabbing';
            trendingContainer.style.userSelect = 'none';
        });

        trendingContainer.addEventListener('mouseleave', () => {
            isDragging = false;
            trendingContainer.style.cursor = 'grab';
        });

        trendingContainer.addEventListener('mouseup', () => {
            isDragging = false;
            trendingContainer.style.cursor = 'grab';
        });

        trendingContainer.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const x = e.pageX - trendingContainer.offsetLeft;
            const walk = (x - startX) * 1.5; // Multiply for faster dragging
            scrollTo(scrollLeft - walk);
        });

        // Touch support for mobile
        let touchStart = 0;
        
        trendingContainer.addEventListener('touchstart', (e) => {
            touchStart = e.touches[0].clientX;
            scrollLeft = currentScroll;
        });

        trendingContainer.addEventListener('touchmove', (e) => {
            if (!touchStart) return;
            const touchCurrent = e.touches[0].clientX;
            const diff = touchStart - touchCurrent;
            scrollTo(scrollLeft + diff);
        });

        trendingContainer.addEventListener('touchend', () => {
            touchStart = 0;
        });

        // Initialize button states
        updateButtons();
        
        // Update on window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                updateButtons();
            }, 250);
        });
    }

    // Start autoplay
    startAutoplay();

    // Pause on hover
    document.querySelector('.hero-carousel').addEventListener('mouseenter', stopAutoplay);
    document.querySelector('.hero-carousel').addEventListener('mouseleave', startAutoplay);
</script>
{% endblock %}