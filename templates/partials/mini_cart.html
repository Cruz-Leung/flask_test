{% set cart = session.get('cart', {}) %}
{% set cart_total = namespace(value=0) %}
{% for key, item in cart.items() %}
    {% set cart_total.value = cart_total.value + (item.price * item.quantity) %}
{% endfor %}
{% set cart_count = cart.values()|map(attribute='quantity')|sum if cart else 0 %}

<div class="mini-cart--dark">
  <div class="mini-cart-header d-flex justify-content-between align-items-center">
    <strong>Cart ({{ cart_count }})</strong>
    <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="document.querySelector('#cartDropdown').click()"></button>
  </div>

  <div class="mini-cart-body mt-2">
    {% if cart and cart_count > 0 %}
      <ul class="list-unstyled mb-2" style="max-height: 260px; overflow-y: auto; overflow-x: hidden;">
        {% for cart_key, item in cart.items() %}
        <li class="d-flex align-items-center py-2 border-bottom" style="max-width: 100%;">
          <!-- Product Image -->
          {% if item.get('image') %}
            <img src="{{ url_for('static', filename='img/' ~ item.image) }}" 
                 alt="{{ item.get('name', 'Product') }}" 
                 style="width:50px;height:50px;object-fit:cover;flex-shrink:0;" 
                 class="me-2 rounded"
                 onerror="this.src='{{ url_for('static', filename='img/placeholder.jpg') }}'">
          {% else %}
            <img src="{{ url_for('static', filename='img/placeholder.jpg') }}" 
                 alt="Product" 
                 style="width:50px;height:50px;object-fit:cover;flex-shrink:0;" 
                 class="me-2 rounded">
          {% endif %}
          
          <!-- Product Info -->
          <div class="flex-grow-1 me-2" style="min-width: 0; overflow: hidden;">
            <div class="small fw-semibold text-white mb-1" style="line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
              {{ item.get('name', 'Unknown Product') }}
            </div>
            <div class="small text-white-50" style="white-space: nowrap;">
              Qty: {{ item.get('quantity', 1) }} Ã— ${{ '%.2f'|format(item.get('price', 0)) }}
            </div>
            <div class="small fw-bold text-warning mt-1">
              ${{ '%.2f'|format(item.get('price', 0) * item.get('quantity', 1)) }}
            </div>
          </div>
          
          <!-- Remove Button -->
          <button type="button" 
                  class="btn btn-sm btn-danger mini-cart-delete-btn" 
                  onclick="removeFromMiniCart('{{ cart_key }}')" 
                  title="Remove"
                  style="flex-shrink: 0; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-trash"></i>
          </button>
        </li>
        {% endfor %}
      </ul>
      
      <!-- Cart Total -->
      <div class="d-flex justify-content-between fw-semibold text-white pt-2 border-top">
        <span>Subtotal:</span>
        <span class="text-warning">${{ '%.2f'|format(cart_total.value) }}</span>
      </div>
    {% else %}
      <div class="mini-cart-empty text-center py-4 text-white-50">
        <i class="bi bi-cart-x fs-1 d-block mb-2"></i>
        <p class="mb-0">Your cart is empty.</p>
      </div>
    {% endif %}
  </div>

  <!-- Action Buttons -->
  <div class="mt-3 d-grid gap-2">
    {% if cart and cart_count > 0 %}
      <a href="{{ url_for('view_cart') }}" class="btn btn-outline-light btn-sm">
        <i class="bi bi-cart3 me-1"></i> View Cart
      </a>
      <a href="{{ url_for('checkout') }}" class="btn btn-light btn-sm">
        <i class="bi bi-credit-card me-1"></i> Checkout
      </a>
    {% else %}
      <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-sm">
        <i class="bi bi-shop me-1"></i> Continue Shopping
      </a>
    {% endif %}
  </div>
</div>

<script>
// Remove item from mini cart
function removeFromMiniCart(cartKey) {
    // Show loading state on button
    const buttons = document.querySelectorAll('.mini-cart-delete-btn');
    buttons.forEach(btn => {
        const onclickStr = btn.getAttribute('onclick');
        if (onclickStr && onclickStr.includes(cartKey)) {
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        }
    });
    
    fetch(`/cart/update/${cartKey}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ quantity: 0 })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page to update cart
            window.location.reload();
        } else {
            alert('Error removing item from cart');
            // Re-enable button on error
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-trash"></i>';
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error removing item from cart');
        // Re-enable button on error
        buttons.forEach(btn => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-trash"></i>';
        });
    });
}
</script>