{% set cart = session.get('cart', {}) %}
{% set cart_total = namespace(value=0) %}
{% for key, item in cart.items() %}
    {% set cart_total.value = cart_total.value + (item.price * item.quantity) %}
{% endfor %}
{% set cart_count = cart.values()|map(attribute='quantity')|sum if cart else 0 %}

<div class="mini-cart--dark">
  <div class="mini-cart-header d-flex justify-content-between align-items-center">
    <strong>Cart ({{ cart_count }})</strong>
    <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="document.querySelector('#cartDropdown').click()"></button>
  </div>

  <div class="mini-cart-body mt-2">
    {% if cart and cart_count > 0 %}
      <ul class="list-unstyled mb-2" style="max-height: 260px; overflow-y: auto;">
        {% for cart_key, item in cart.items() %}
        <li class="d-flex align-items-center py-2 border-bottom">
          {% if item.image %}
            <img src="{{ url_for('static', filename='img/' + item.image) }}" alt="{{ item.name }}" style="width:46px;height:46px;object-fit:cover" class="me-2 rounded">
          {% else %}
            <img src="{{ url_for('static', filename='img/placeholder.jpg') }}" alt="{{ item.name }}" style="width:46px;height:46px;object-fit:cover" class="me-2 rounded">
          {% endif %}
          <div class="flex-grow-1">
            <div class="small fw-semibold text-white mb-1">{{ item.name }}</div>
            <div class="small text-white-50">x{{ item.quantity }} Â· ${{ '%.2f'|format(item.price) }}</div>
          </div>
          <button type="button" 
                  class="btn btn-sm btn-danger mini-cart-delete-btn" 
                  onclick="removeFromMiniCart('{{ item.product_id }}')" 
                  title="Remove">
            <i class="bi bi-x-lg"></i>
          </button>
        </li>
        {% endfor %}
      </ul>
      <div class="d-flex justify-content-between fw-semibold text-white">
        <span>Total</span>
        <span>${{ '%.2f'|format(cart_total.value) }}</span>
      </div>
    {% else %}
      <div class="mini-cart-empty text-center py-3 text-white-50">Your cart is empty.</div>
    {% endif %}
  </div>

  <div class="mt-3 d-grid gap-2">
    <a href="{{ url_for('view_cart') }}" class="btn btn-outline-light btn-sm">View Cart</a>
    <a href="{{ url_for('checkout') }}" class="btn btn-light btn-sm">Checkout</a>
  </div>
</div>

<script>
// Remove item from mini cart - NO POPUP
function removeFromMiniCart(productId) {
    // Show loading state on button
    const buttons = document.querySelectorAll('.mini-cart-delete-btn');
    buttons.forEach(btn => {
        if (btn.onclick.toString().includes(productId)) {
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        }
    });
    
    fetch(`/cart/update/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ quantity: 0 })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page to update cart
            window.location.reload();
        } else {
            alert('Error removing item from cart');
            // Re-enable button on error
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-x-lg"></i>';
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error removing item from cart');
        // Re-enable button on error
        buttons.forEach(btn => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-x-lg"></i>';
        });
    });
}
</script>