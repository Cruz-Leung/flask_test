{% extends "base.html" %}

{% block title %}Edit Profile - Cruzy Coffee Co.{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card shadow">
                <div class="card-body p-4">
                    <h2 class="mb-4">Edit Profile</h2>

                    <form method="post" id="editAccountForm">
                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ user.name }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" name="phone" 
                                   value="{{ user.phone or '' }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="address" name="address" 
                                   value="{{ user.address or '' }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="city" class="form-label">City</label>
                            <input type="text" class="form-control" id="city" name="city" 
                                   value="{{ user.city or '' }}">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state" name="state" 
                                       value="{{ user.state or '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="postcode" class="form-label">Postcode</label>
                                <input type="text" class="form-control" id="postcode" name="postcode" 
                                       value="{{ user.postcode or '' }}">
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h5 class="mb-3">Change Password (optional)</h5>
                        <p class="text-muted small mb-3">Leave blank to keep current password</p>
                        
                        <div class="mb-3">
                            <label for="current_password" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="current_password" name="current_password">
                            <small class="text-muted">Required if changing password</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="new_password" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="new_password" name="new_password">
                            
                            <!-- Password strength indicator (hidden by default) -->
                            <div id="password-strength-container" style="display: none;">
                                <div class="mt-2">
                                    <div class="progress" style="height: 5px;">
                                        <div id="passwordStrength" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="strengthText" class="text-muted"></small>
                                </div>
                                
                                <!-- Password requirements checklist -->
                                <div class="mt-3 password-requirements">
                                    <small class="fw-bold">New password must include:</small>
                                    <ul class="list-unstyled mt-2 small">
                                        <li id="req-length">
                                            <i class="bi bi-x-circle text-danger"></i>
                                            <span>At least 8 characters</span>
                                        </li>
                                        <li id="req-uppercase">
                                            <i class="bi bi-x-circle text-danger"></i>
                                            <span>One uppercase letter (A-Z)</span>
                                        </li>
                                        <li id="req-lowercase">
                                            <i class="bi bi-x-circle text-danger"></i>
                                            <span>One lowercase letter (a-z)</span>
                                        </li>
                                        <li id="req-number">
                                            <i class="bi bi-x-circle text-danger"></i>
                                            <span>One number (0-9)</span>
                                        </li>
                                        <li id="req-special">
                                            <i class="bi bi-x-circle text-danger"></i>
                                            <span>One special character (!@#$%^&*)</span>
                                        </li>
                                        <li id="req-common">
                                            <i class="bi bi-x-circle text-danger"></i>
                                            <span>Not a common password</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="confirm-password-container" style="display: none;">
                            <label for="confirm_password" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password">
                            <div id="passwordMatch" class="mt-1"></div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-dark" id="submitBtn">Save Changes</button>
                            <a href="{{ url_for('account') }}" class="btn btn-outline-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Common weak passwords to block
    const COMMON_PASSWORDS = [
        'password', 'password123', '123456', '12345678', 'qwerty', 'abc123',
        'monkey', 'letmein', 'trustno1', 'dragon', 'baseball', 'iloveyou',
        'master', 'sunshine', 'ashley', 'bailey', 'shadow', 'superman',
        'coffee', 'espresso', 'cappuccino', 'latte', 'cruzy', 'admin',
        'qwertyuiop', 'asdfghjkl', 'zxcvbnm', '1234567890',
        'passw0rd', 'p@ssword', 'p@ssw0rd', 'welcome', 'login'
    ];

    const SEQUENTIAL_PATTERNS = [
        'abcd', 'bcde', 'cdef', 'defg', 'efgh', 'fghi', 'ghij', 'hijk',
        '1234', '2345', '3456', '4567', '5678', '6789', '7890',
        'qwer', 'wert', 'erty', 'rtyu', 'tyui', 'yuio', 'uiop',
        'asdf', 'sdfg', 'dfgh', 'fghj', 'ghjk', 'hjkl'
    ];

    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        const newPasswordInput = document.getElementById('new_password');
        const confirmInput = document.getElementById('confirm_password');
        const currentPasswordInput = document.getElementById('current_password');
        const nameInput = document.getElementById('name');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('editAccountForm');
        const strengthContainer = document.getElementById('password-strength-container');
        const confirmContainer = document.getElementById('confirm-password-container');

        let requirements = {
            length: false,
            uppercase: false,
            lowercase: false,
            number: false,
            special: false,
            common: false,
            match: false
        };

        let passwordChangeMode = false;

        function updateRequirement(id, passed) {
            const elem = document.getElementById(id);
            if (!elem) return;
            const icon = elem.querySelector('i');
            
            if (passed) {
                icon.className = 'bi bi-check-circle text-success';
                elem.style.color = '#198754';
            } else {
                icon.className = 'bi bi-x-circle text-danger';
                elem.style.color = '#dc3545';
            }
        }

        function checkPasswordStrength(password) {
            let score = 0;
            
            // Length check
            requirements.length = password.length >= 8;
            updateRequirement('req-length', requirements.length);
            if (requirements.length) score += 20;
            
            // Uppercase check
            requirements.uppercase = /[A-Z]/.test(password);
            updateRequirement('req-uppercase', requirements.uppercase);
            if (requirements.uppercase) score += 20;
            
            // Lowercase check
            requirements.lowercase = /[a-z]/.test(password);
            updateRequirement('req-lowercase', requirements.lowercase);
            if (requirements.lowercase) score += 20;
            
            // Number check
            requirements.number = /[0-9]/.test(password);
            updateRequirement('req-number', requirements.number);
            if (requirements.number) score += 20;
            
            // Special character check
            requirements.special = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            updateRequirement('req-special', requirements.special);
            if (requirements.special) score += 20;
            
            // Check for common passwords
            const lowerPassword = password.toLowerCase().trim();
            const isCommon = COMMON_PASSWORDS.includes(lowerPassword);
            
            // Check for sequential patterns
            const hasSequential = SEQUENTIAL_PATTERNS.some(pattern => 
                lowerPassword.includes(pattern)
            );
            
            // Check for repeating characters (e.g., 'aaaa', '1111')
            const hasRepeating = /(.)\1{3,}/.test(password);
            
            // Check if password contains name
            const name = nameInput.value.toLowerCase();
            const containsPersonalInfo = (name && lowerPassword.includes(name));
            
            // Check for leading/trailing spaces
            const hasSpaces = password !== password.trim();
            
            requirements.common = !isCommon && !hasSequential && !hasRepeating && 
                                 !containsPersonalInfo && !hasSpaces;
            updateRequirement('req-common', requirements.common);
            
            // Update strength bar
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('strengthText');
            
            strengthBar.style.width = score + '%';
            
            if (score === 0) {
                strengthBar.className = 'progress-bar';
                strengthText.textContent = '';
            } else if (score < 40) {
                strengthBar.className = 'progress-bar bg-danger';
                strengthText.textContent = 'Weak password';
                strengthText.className = 'text-danger';
            } else if (score < 80) {
                strengthBar.className = 'progress-bar bg-warning';
                strengthText.textContent = 'Medium strength';
                strengthText.className = 'text-warning';
            } else if (score < 100) {
                strengthBar.className = 'progress-bar bg-info';
                strengthText.textContent = 'Good password';
                strengthText.className = 'text-info';
            } else {
                strengthBar.className = 'progress-bar bg-success';
                strengthText.textContent = 'Strong password!';
                strengthText.className = 'text-success';
            }
            
            checkFormValidity();
        }

        function checkPasswordMatch() {
            const password = newPasswordInput.value;
            const confirm = confirmInput.value;
            const matchDiv = document.getElementById('passwordMatch');
            
            if (confirm === '') {
                matchDiv.innerHTML = '';
                requirements.match = false;
            } else if (password === confirm) {
                matchDiv.innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> Passwords match</small>';
                requirements.match = true;
            } else {
                matchDiv.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle"></i> Passwords do not match</small>';
                requirements.match = false;
            }
            
            checkFormValidity();
        }

        function checkFormValidity() {
            if (passwordChangeMode) {
                // If changing password, all requirements must be met
                const allRequirementsMet = Object.values(requirements).every(req => req === true);
                const currentPasswordFilled = currentPasswordInput.value.length > 0;
                submitBtn.disabled = !allRequirementsMet || !currentPasswordFilled;
            } else {
                // If not changing password, form is always valid
                submitBtn.disabled = false;
            }
        }

        // Event listeners
        newPasswordInput.addEventListener('input', function() {
            const hasPassword = this.value.length > 0;
            
            console.log('New password input detected:', hasPassword); // Debug log
            
            // Toggle password change mode
            passwordChangeMode = hasPassword;
            
            if (hasPassword) {
                // Show password strength and confirm field
                console.log('Showing password requirements'); // Debug log
                strengthContainer.style.display = 'block';
                confirmContainer.style.display = 'block';
                checkPasswordStrength(this.value);
            } else {
                // Hide password strength and confirm field
                console.log('Hiding password requirements'); // Debug log
                strengthContainer.style.display = 'none';
                confirmContainer.style.display = 'none';
                confirmInput.value = '';
                
                // Reset requirements
                requirements = {
                    length: false,
                    uppercase: false,
                    lowercase: false,
                    number: false,
                    special: false,
                    common: false,
                    match: false
                };
                
                checkFormValidity();
            }
        });

        confirmInput.addEventListener('input', checkPasswordMatch);
        
        // Also trigger password match check when new password changes
        newPasswordInput.addEventListener('input', function() {
            if (confirmInput.value.length > 0) {
                checkPasswordMatch();
            }
        });
        
        currentPasswordInput.addEventListener('input', checkFormValidity);
        
        nameInput.addEventListener('input', function() {
            if (newPasswordInput.value) {
                checkPasswordStrength(newPasswordInput.value);
            }
        });

        // Form submission validation
        form.addEventListener('submit', function(e) {
            if (passwordChangeMode) {
                // Validate current password is filled
                if (!currentPasswordInput.value) {
                    e.preventDefault();
                    alert('Please enter your current password to change it.');
                    currentPasswordInput.focus();
                    return false;
                }
                
                // Validate all password requirements
                const allRequirementsMet = Object.values(requirements).every(req => req === true);
                
                if (!allRequirementsMet) {
                    e.preventDefault();
                    alert('Please ensure all password requirements are met.');
                    return false;
                }
            }
        });

        console.log('Edit account password validation initialized'); // Debug log
    });
</script>

<style>
    .password-requirements li {
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .password-requirements i {
        margin-right: 0.5rem;
    }
</style>
{% endblock %}