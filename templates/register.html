{% extends "base.html" %}

{% block title %}Register - Cruzy Coffee Co.{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card shadow">
                <div class="card-body p-5">
                    <h2 class="text-center mb-4">Create Account</h2>

                    <form method="post" id="registerForm">
                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="name" name="name" required autofocus>
                        </div>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                            
                            <!-- Password strength indicator -->
                            <div class="mt-2">
                                <div class="progress" style="height: 5px;">
                                    <div id="passwordStrength" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="strengthText" class="text-muted"></small>
                            </div>
                            
                            <!-- Password requirements checklist -->
                            <div class="mt-3 password-requirements">
                                <small class="fw-bold">Password must include:</small>
                                <ul class="list-unstyled mt-2 small">
                                    <li id="req-length">
                                        <i class="bi bi-x-circle text-danger"></i>
                                        <span>At least 8 characters</span>
                                    </li>
                                    <li id="req-uppercase">
                                        <i class="bi bi-x-circle text-danger"></i>
                                        <span>One uppercase letter (A-Z)</span>
                                    </li>
                                    <li id="req-lowercase">
                                        <i class="bi bi-x-circle text-danger"></i>
                                        <span>One lowercase letter (a-z)</span>
                                    </li>
                                    <li id="req-number">
                                        <i class="bi bi-x-circle text-danger"></i>
                                        <span>One number (0-9)</span>
                                    </li>
                                    <li id="req-special">
                                        <i class="bi bi-x-circle text-danger"></i>
                                        <span>One special character (!@#$%^&*)</span>
                                    </li>
                                    <li id="req-common">
                                        <i class="bi bi-x-circle text-danger"></i>
                                        <span>Not a common password</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                            <div id="passwordMatch" class="mt-1"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone (optional)</label>
                            <input type="tel" class="form-control" id="phone" name="phone">
                        </div>
                        
                        <div class="mb-3">
                            <label for="address" class="form-label">Address (optional)</label>
                            <input type="text" class="form-control" id="address" name="address">
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-dark" id="submitBtn" disabled>Create Account</button>
                        </div>
                    </form>

                    <hr class="my-4">
                    
                    <p class="text-center mb-0">
                        Already have an account? 
                        <a href="{{ url_for('login') }}">Login here</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Common weak passwords to block
    const COMMON_PASSWORDS = [
        'password', 'password123', '123456', '12345678', 'qwerty', 'abc123',
        'monkey', 'letmein', 'trustno1', 'dragon', 'baseball', 'iloveyou',
        'master', 'sunshine', 'ashley', 'bailey', 'shadow', 'superman',
        'coffee', 'espresso', 'cappuccino', 'latte', 'cruzy', 'admin',
        'qwertyuiop', 'asdfghjkl', 'zxcvbnm', '1234567890',
        'passw0rd', 'p@ssword', 'p@ssw0rd', 'welcome', 'login'
    ];

    const SEQUENTIAL_PATTERNS = [
        'abcd', 'bcde', 'cdef', 'defg', 'efgh', 'fghi', 'ghij', 'hijk',
        '1234', '2345', '3456', '4567', '5678', '6789', '7890',
        'qwer', 'wert', 'erty', 'rtyu', 'tyui', 'yuio', 'uiop',
        'asdf', 'sdfg', 'dfgh', 'fghj', 'ghjk', 'hjkl'
    ];

    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm_password');
    const nameInput = document.getElementById('name');
    const emailInput = document.getElementById('email');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('registerForm');

    let requirements = {
        length: false,
        uppercase: false,
        lowercase: false,
        number: false,
        special: false,
        common: false,
        match: false
    };

    function updateRequirement(id, passed) {
        const elem = document.getElementById(id);
        const icon = elem.querySelector('i');
        
        if (passed) {
            icon.className = 'bi bi-check-circle text-success';
            elem.style.color = '#198754';
        } else {
            icon.className = 'bi bi-x-circle text-danger';
            elem.style.color = '#dc3545';
        }
    }

    function checkPasswordStrength(password) {
        let score = 0;
        
        // Length check
        requirements.length = password.length >= 8;
        updateRequirement('req-length', requirements.length);
        if (requirements.length) score += 20;
        
        // Uppercase check
        requirements.uppercase = /[A-Z]/.test(password);
        updateRequirement('req-uppercase', requirements.uppercase);
        if (requirements.uppercase) score += 20;
        
        // Lowercase check
        requirements.lowercase = /[a-z]/.test(password);
        updateRequirement('req-lowercase', requirements.lowercase);
        if (requirements.lowercase) score += 20;
        
        // Number check
        requirements.number = /[0-9]/.test(password);
        updateRequirement('req-number', requirements.number);
        if (requirements.number) score += 20;
        
        // Special character check
        requirements.special = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
        updateRequirement('req-special', requirements.special);
        if (requirements.special) score += 20;
        
        // Check for common passwords
        const lowerPassword = password.toLowerCase().trim();
        const isCommon = COMMON_PASSWORDS.includes(lowerPassword);
        
        // Check for sequential patterns
        const hasSequential = SEQUENTIAL_PATTERNS.some(pattern => 
            lowerPassword.includes(pattern)
        );
        
        // Check for repeating characters (e.g., 'aaaa', '1111')
        const hasRepeating = /(.)\1{3,}/.test(password);
        
        // Check if password contains name or email
        const name = nameInput.value.toLowerCase();
        const email = emailInput.value.toLowerCase().split('@')[0];
        const containsPersonalInfo = (name && lowerPassword.includes(name)) || 
                                    (email && lowerPassword.includes(email));
        
        // Check for leading/trailing spaces
        const hasSpaces = password !== password.trim();
        
        requirements.common = !isCommon && !hasSequential && !hasRepeating && 
                             !containsPersonalInfo && !hasSpaces;
        updateRequirement('req-common', requirements.common);
        
        // Update strength bar
        const strengthBar = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('strengthText');
        
        strengthBar.style.width = score + '%';
        
        if (score === 0) {
            strengthBar.className = 'progress-bar';
            strengthText.textContent = '';
        } else if (score < 40) {
            strengthBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Weak password';
            strengthText.className = 'text-danger';
        } else if (score < 80) {
            strengthBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Medium strength';
            strengthText.className = 'text-warning';
        } else if (score < 100) {
            strengthBar.className = 'progress-bar bg-info';
            strengthText.textContent = 'Good password';
            strengthText.className = 'text-info';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Strong password!';
            strengthText.className = 'text-success';
        }
        
        checkFormValidity();
    }

    function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        const matchDiv = document.getElementById('passwordMatch');
        
        if (confirm === '') {
            matchDiv.innerHTML = '';
            requirements.match = false;
        } else if (password === confirm) {
            matchDiv.innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> Passwords match</small>';
            requirements.match = true;
        } else {
            matchDiv.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle"></i> Passwords do not match</small>';
            requirements.match = false;
        }
        
        checkFormValidity();
    }

    function checkFormValidity() {
        const allRequirementsMet = Object.values(requirements).every(req => req === true);
        submitBtn.disabled = !allRequirementsMet;
    }

    // Event listeners
    passwordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
    });

    confirmInput.addEventListener('input', checkPasswordMatch);
    passwordInput.addEventListener('input', checkPasswordMatch);
    nameInput.addEventListener('input', function() {
        if (passwordInput.value) {
            checkPasswordStrength(passwordInput.value);
        }
    });
    emailInput.addEventListener('input', function() {
        if (passwordInput.value) {
            checkPasswordStrength(passwordInput.value);
        }
    });

    // Form submission validation
    form.addEventListener('submit', function(e) {
        const allRequirementsMet = Object.values(requirements).every(req => req === true);
        
        if (!allRequirementsMet) {
            e.preventDefault();
            alert('Please ensure all password requirements are met.');
            return false;
        }
    });
</script>

<style>
    .password-requirements li {
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .password-requirements i {
        margin-right: 0.5rem;
    }
</style>
{% endblock %}