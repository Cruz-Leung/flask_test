{% extends "base.html" %}

{% block title %}Edit Products - Cruzy Coffee Co.{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row g-3">
        <!-- LEFT SIDE: Product List (2/3 width) -->
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Edit Products</h2>
                <a href="{{ url_for('add_product') }}" class="btn btn-dark">
                    <i class="bi bi-plus-circle"></i> Add New Product
                </a>
            </div>

            <!-- Search and Filter -->
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <form method="get" action="{{ url_for('edit_product') }}">
                        <div class="row g-2">
                            <div class="col-md-5">
                                <input type="text" name="search" class="form-control" 
                                       placeholder="Search by ID, SKU, or name..." 
                                       value="{{ search }}">
                            </div>
                            <div class="col-md-4">
                                <select name="category" class="form-select">
                                    <option value="">All Categories</option>
                                    <option value="machines" {% if category_filter == 'machines' %}selected{% endif %}>Machines</option>
                                    <option value="beans" {% if category_filter == 'beans' %}selected{% endif %}>Beans</option>
                                    <option value="accessories" {% if category_filter == 'accessories' %}selected{% endif %}>Accessories</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">Search</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Products List -->
            <div class="card shadow">
                <div class="card-body p-0">
                    {% if products %}
                    <div style="max-height: 70vh; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead class="sticky-top bg-light">
                                <tr>
                                    <th style="width: 50px;">ID</th>
                                    <th style="width: 60px;">Image</th>
                                    <th style="width: 90px;">SKU</th>
                                    <th>Name</th>
                                    <th style="width: 100px;">Category</th>
                                    <th style="width: 80px;">Price</th>
                                    <th style="width: 60px;">Stock</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in products %}
                                <tr class="product-row" 
                                    onclick="window.location.href='{{ url_for('edit_product', sku=p.sku, search=search, category=category_filter) }}'"
                                    style="cursor: pointer;"
                                    {% if product and product.sku == p.sku %}class="table-active"{% endif %}>
                                    <td><small>#{{ p.id }}</small></td>
                                    <td>
                                        {% if p.image %}
                                        <img src="{{ url_for('static', filename='img/' + p.image) }}" 
                                             alt="{{ p.name }}" 
                                             style="width: 40px; height: 40px; object-fit: cover;" 
                                             class="rounded">
                                        {% else %}
                                        <div style="width: 40px; height: 40px;" class="bg-secondary rounded"></div>
                                        {% endif %}
                                    </td>
                                    <td><code class="small">{{ p.sku }}</code></td>
                                    <td>
                                        <strong>{{ p.name }}</strong>
                                        {% if p.subcategory %}
                                        <br><small class="text-muted">{{ p.subcategory }}</small>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-secondary">{{ p.category }}</span></td>
                                    <td><strong>${{ '%.2f'|format(p.price) }}</strong></td>
                                    <td>
                                        {% if p.stock == 0 %}
                                        <span class="badge bg-danger">{{ p.stock }}</span>
                                        {% elif p.stock < 10 %}
                                        <span class="badge bg-warning text-dark">{{ p.stock }}</span>
                                        {% else %}
                                        <span class="badge bg-success">{{ p.stock }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-light border-top">
                        <small class="text-muted">Total Products: <strong>{{ products|length }}</strong></small>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <p class="lead text-muted">No products found.</p>
                        <a href="{{ url_for('add_product') }}" class="btn btn-dark">Add Your First Product</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- RIGHT SIDE: Edit Form (1/3 width) -->
        <div class="col-lg-4">
            <div class="card shadow sticky-top" style="top: 20px;">
                <div class="card-body">
                    {% if product %}
                    <h5 class="card-title mb-3">Edit Product</h5>
                    
                    <form method="post" enctype="multipart/form-data">
                        <input type="hidden" name="old_sku" value="{{ product.sku }}">

                        <div class="mb-3">
                            <label for="sku" class="form-label">SKU</label>
                            <input type="text" class="form-control form-control-sm" id="sku" name="sku" 
                                   value="{{ product.sku }}" 
                                   {% if session.user_role != 'manager' %}readonly{% endif %} required>
                            {% if session.user_role != 'manager' %}
                            <small class="text-muted">Only managers can change SKU</small>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control form-control-sm" id="name" name="name" 
                                   value="{{ product.name }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select form-select-sm" id="category" name="category" required>
                                <option value="machines" {% if product.category == 'machines' %}selected{% endif %}>Machines</option>
                                <option value="beans" {% if product.category == 'beans' %}selected{% endif %}>Beans</option>
                                <option value="accessories" {% if product.category == 'accessories' %}selected{% endif %}>Accessories</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="subcategory" class="form-label">Subcategory</label>
                            <select class="form-select form-select-sm" id="subcategory" name="subcategory" required>
                                <option value="">-- Select Category First --</option>
                            </select>
                            <small class="text-muted" id="subcategory-hint">Choose a category to see subcategories</small>
                        </div>

                        <div class="row">
                            <div class="col-6 mb-3">
                                <label for="price" class="form-label">Price ($)</label>
                                <input type="number" class="form-control form-control-sm" id="price" name="price" 
                                       step="0.01" value="{{ product.price }}" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label for="stock" class="form-label">Stock</label>
                                <input type="number" class="form-control form-control-sm" id="stock" name="stock" 
                                       value="{{ product.stock }}" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control form-control-sm" id="description" name="description" rows="3">{{ product.description or '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="image" class="form-label">Image</label>
                            {% if product.image %}
                            <div class="mb-2">
                                <img src="{{ url_for('static', filename='img/' + product.image) }}" 
                                     alt="{{ product.name }}" 
                                     style="width: 100%; max-width: 200px;" class="rounded">
                            </div>
                            {% endif %}
                            <input type="file" class="form-control form-control-sm" id="image" name="image" accept="image/*">
                        </div>

                        <div class="mb-3">
                            <label for="discount_percentage" class="form-label">Discount (%)</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="discount_percentage" 
                                   name="discount_percentage" 
                                   min="0" 
                                   max="100"
                                   value="{{ product.discount_percentage if product else 0 }}"
                                   placeholder="0">
                            <small class="text-muted">Enter 0 for no discount, 10 for 10% off, etc.</small>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-save"></i> Save Changes
                            </button>
                            <a href="{{ url_for('edit_product', search=search, category=category_filter) }}" class="btn btn-outline-secondary btn-sm">Clear Selection</a>
                        </div>
                    </form>

                    <hr class="my-3">

                    <form method="post" action="{{ url_for('delete_product', sku=product.sku) }}" 
                          onsubmit="return confirm('Delete {{ product.name }}? This cannot be undone.')">
                        <button type="submit" class="btn btn-danger btn-sm w-100">
                            <i class="bi bi-trash"></i> Delete Product
                        </button>
                    </form>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-arrow-left-circle display-1 text-muted"></i>
                        <p class="text-muted mt-3">Click on a product from the list to edit</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    /* Hover effect for product rows */
    .product-row:hover {
        background-color: #f8f9fa !important;
        transition: background-color 0.2s ease;
    }
    
    /* Active/selected row styling */
    .table-active {
        background-color: #e7f3ff !important;
        border-left: 4px solid #0d6efd;
    }
    
    .table-active:hover {
        background-color: #d0e7ff !important;
    }
</style>

<script>
    // Subcategory options for each category
    const subcategoryOptions = {
        'machines': [
            { value: 'semi-auto', label: 'Semi-Automatic' },
            { value: 'auto', label: 'Automatic' },
            { value: 'manual', label: 'Manual' }
        ],
        'beans': [
            { value: 'coffee-beans', label: 'Coffee Beans' },
            { value: 'ground-coffee', label: 'Ground Coffee/Capsules' },
            { value: 'capsules', label: 'Capsules' }
        ],
        'accessories': [
            { value: 'brewing-equipment', label: 'Brewing Equipment' },
            { value: 'grinders', label: 'Grinders' }
        ]
    };

    // Get form elements
    const categorySelect = document.getElementById('category');
    const subcategorySelect = document.getElementById('subcategory');
    const subcategoryHint = document.getElementById('subcategory-hint');

    // Store the current subcategory value (for edit mode)
    const currentSubcategory = "{{ product.subcategory if product else '' }}";

    // Function to update subcategory dropdown based on category
    function updateSubcategoryOptions() {
        const selectedCategory = categorySelect.value;
        
        // Clear existing options
        subcategorySelect.innerHTML = '';
        
        if (selectedCategory && subcategoryOptions[selectedCategory]) {
            // Add subcategory options for selected category
            subcategoryOptions[selectedCategory].forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.label;
                
                // Select current subcategory if editing
                if (option.value === currentSubcategory) {
                    optionElement.selected = true;
                }
                
                subcategorySelect.appendChild(optionElement);
            });
            
            subcategorySelect.disabled = false;
            subcategoryHint.textContent = `Select a subcategory for ${selectedCategory}`;
        } else {
            // No category selected
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = '-- Select Category First --';
            subcategorySelect.appendChild(placeholderOption);
            subcategorySelect.disabled = true;
            subcategoryHint.textContent = 'Choose a category to see subcategories';
        }
    }

    // Update subcategory options when category changes
    categorySelect.addEventListener('change', updateSubcategoryOptions);

    // Initialize subcategory dropdown on page load
    updateSubcategoryOptions();

    // Prevent row click when interacting with form elements
    document.querySelectorAll('.product-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // Allow normal link/button behavior if they exist
            if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
                e.stopPropagation();
            }
        });
    });

    console.log('Edit products page loaded - {{ products|length }} products found');
</script>
{% endblock %}